<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Голосовой ИИ-помощник</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3B82F6">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Иконки (заменяем lucide-react на простые SVG)
        const MicIcon = () => (
            <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                <path d="M19 10v1a7 7 0 0 1-14 0v-1"/>
                <line x1="12" x2="12" y1="19" y2="23"/>
                <line x1="8" x2="16" y1="23" y2="23"/>
            </svg>
        );

        const MicOffIcon = () => (
            <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor">
                <line x1="2" x2="22" y1="2" y2="22"/>
                <path d="M18.89 13.23A7.12 7.12 0 0 0 19 12v-1"/>
                <path d="M15.54 8.46A3 3 0 0 0 12 5a3 3 0 0 0-3 3v1l4.54 4.54"/>
                <path d="M9 9v2a3 3 0 0 0 5.12 2.12l1.42 1.42A7 7 0 0 1 5 12v-1"/>
                <line x1="12" x2="12" y1="19" y2="23"/>
                <line x1="8" x2="16" y1="23" y2="23"/>
            </svg>
        );

        const SettingsIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
        );

        const VolumeXIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                <line x1="22" x2="16" y1="9" y2="15"/>
                <line x1="16" x2="22" y1="9" y2="15"/>
            </svg>
        );

        const VoiceAIAssistant = () => {
            const [isListening, setIsListening] = useState(false);
            const [transcript, setTranscript] = useState('');
            const [response, setResponse] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [assistantName, setAssistantName] = useState('Алиса');
            const [apiKey, setApiKey] = useState('');
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [conversationHistory, setConversationHistory] = useState([]);
            
            const recognitionRef = useRef(null);

            useEffect(() => {
                // Инициализация Speech Recognition
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = false;
                    recognitionRef.current.interimResults = true;
                    recognitionRef.current.lang = 'ru-RU';

                    recognitionRef.current.onresult = (event) => {
                        const current = event.resultIndex;
                        const transcript = event.results[current][0].transcript;
                        setTranscript(transcript);

                        if (event.results[current].isFinal) {
                            handleVoiceInput(transcript);
                        }
                    };

                    recognitionRef.current.onend = () => {
                        setIsListening(false);
                    };

                    recognitionRef.current.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        setIsListening(false);
                    };
                }

                // Загрузка настроек из localStorage
                const savedName = localStorage.getItem('assistantName');
                const savedApiKey = localStorage.getItem('apiKey');
                if (savedName) setAssistantName(savedName);
                if (savedApiKey) setApiKey(savedApiKey);
            }, []);

            const startListening = () => {
                if (recognitionRef.current && !isListening) {
                    setTranscript('');
                    setResponse('');
                    setIsListening(true);
                    recognitionRef.current.start();
                }
            };

            const stopListening = () => {
                if (recognitionRef.current && isListening) {
                    recognitionRef.current.stop();
                    setIsListening(false);
                }
            };

            const handleVoiceInput = async (text) => {
                const lowerText = text.toLowerCase();
                const lowerName = assistantName.toLowerCase();
                
                // Проверяем, обращаются ли к помощнику по имени
                if (!lowerText.includes(lowerName)) {
                    setResponse(`Обратитесь ко мне по имени "${assistantName}"`);
                    speak(`Обратитесь ко мне по имени ${assistantName}`);
                    return;
                }

                // Убираем имя из текста для обработки
                const cleanText = text.replace(new RegExp(assistantName, 'gi'), '').trim();
                
                setIsProcessing(true);
                
                try {
                    // Добавляем сообщение пользователя в историю
                    const newUserMessage = { role: "user", content: cleanText };
                    const updatedHistory = [...conversationHistory, newUserMessage];
                    
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 1000,
                            messages: updatedHistory
                        })
                    });

                    const data = await response.json();
                    const aiResponse = data.content[0].text;
                    
                    // Добавляем ответ ИИ в историю
                    const newAssistantMessage = { role: "assistant", content: aiResponse };
                    setConversationHistory([...updatedHistory, newAssistantMessage]);
                    
                    setResponse(aiResponse);
                    speak(aiResponse);
                    
                } catch (error) {
                    console.error('Error calling AI API:', error);
                    const errorMsg = 'Извините, произошла ошибка при обращении к ИИ';
                    setResponse(errorMsg);
                    speak(errorMsg);
                }
                
                setIsProcessing(false);
            };

            const speak = (text) => {
                if ('speechSynthesis' in window) {
                    // Останавливаем предыдущий синтез речи
                    window.speechSynthesis.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'ru-RU';
                    utterance.rate = 0.9;
                    utterance.pitch = 1;
                    
                    utterance.onstart = () => setIsSpeaking(true);
                    utterance.onend = () => setIsSpeaking(false);
                    utterance.onerror = () => setIsSpeaking(false);
                    
                    window.speechSynthesis.speak(utterance);
                }
            };

            const stopSpeaking = () => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    setIsSpeaking(false);
                }
            };

            const saveSettings = () => {
                localStorage.setItem('assistantName', assistantName);
                localStorage.setItem('apiKey', apiKey);
                setShowSettings(false);
            };

            const clearHistory = () => {
                setConversationHistory([]);
                setTranscript('');
                setResponse('');
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex flex-col">
                    {/* Header */}
                    <div className="bg-white/80 backdrop-blur-sm shadow-sm p-4 flex justify-between items-center">
                        <h1 className="text-2xl font-bold text-gray-800">Голосовой ИИ</h1>
                        <button
                            onClick={() => setShowSettings(!showSettings)}
                            className="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors"
                        >
                            <SettingsIcon />
                        </button>
                    </div>

                    {/* Settings Panel */}
                    {showSettings && (
                        <div className="bg-white/90 backdrop-blur-sm p-6 mx-4 mt-4 rounded-xl shadow-lg">
                            <h3 className="text-lg font-semibold mb-4">Настройки</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Имя помощника
                                    </label>
                                    <input
                                        type="text"
                                        value={assistantName}
                                        onChange={(e) => setAssistantName(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Введите имя помощника"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        API Ключ (оставьте пустым для использования встроенного ИИ)
                                    </label>
                                    <input
                                        type="password"
                                        value={apiKey}
                                        onChange={(e) => setApiKey(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Введите API ключ"
                                    />
                                </div>
                                <div className="flex space-x-3">
                                    <button
                                        onClick={saveSettings}
                                        className="flex-1 bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors"
                                    >
                                        Сохранить
                                    </button>
                                    <button
                                        onClick={clearHistory}
                                        className="flex-1 bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors"
                                    >
                                        Очистить историю
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <div className="flex-1 flex flex-col items-center justify-center p-6">
                        {/* Status Display */}
                        <div className="mb-8 text-center">
                            <h2 className="text-3xl font-bold text-gray-800 mb-2">
                                {assistantName}
                            </h2>
                            <p className="text-gray-600">
                                {isListening ? 'Слушаю...' : 
                                 isProcessing ? 'Обрабатываю...' : 
                                 isSpeaking ? 'Говорю...' : 
                                 `Скажите "${assistantName}" для активации`}
                            </p>
                        </div>

                        {/* Microphone Button */}
                        <div className="relative mb-8">
                            <button
                                onClick={isListening ? stopListening : startListening}
                                disabled={isProcessing}
                                className={`relative w-24 h-24 rounded-full shadow-lg transition-all duration-300 flex items-center justify-center ${
                                    isListening 
                                        ? 'bg-red-500 hover:bg-red-600 scale-110' 
                                        : isProcessing 
                                        ? 'bg-yellow-500 animate-pulse' 
                                        : 'bg-blue-500 hover:bg-blue-600 hover:scale-105'
                                } disabled:opacity-50`}
                            >
                                <div className="text-white">
                                    {isListening ? <MicOffIcon /> : <MicIcon />}
                                </div>
                            </button>
                            
                            {isListening && (
                                <div className="absolute inset-0 rounded-full border-4 border-red-400 animate-ping"></div>
                            )}
                        </div>

                        {/* Speech Control */}
                        {isSpeaking && (
                            <button
                                onClick={stopSpeaking}
                                className="mb-4 flex items-center space-x-2 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors"
                            >
                                <VolumeXIcon />
                                <span>Остановить речь</span>
                            </button>
                        )}

                        {/* Transcript */}
                        {transcript && (
                            <div className="w-full max-w-2xl mb-4 p-4 bg-white/70 backdrop-blur-sm rounded-xl shadow-sm">
                                <p className="text-gray-700">
                                    <strong>Вы сказали:</strong> {transcript}
                                </p>
                            </div>
                        )}

                        {/* Response */}
                        {response && (
                            <div className="w-full max-w-2xl p-4 bg-white/70 backdrop-blur-sm rounded-xl shadow-sm">
                                <p className="text-gray-700">
                                    <strong>{assistantName}:</strong> {response}
                                </p>
                            </div>
                        )}

                        {/* Instructions */}
                        <div className="mt-8 text-center text-sm text-gray-500 max-w-md">
                            <p>
                                • Нажмите на микрофон и скажите "{assistantName}, [ваш вопрос]"
                            </p>
                            <p>
                                • Приложение использует встроенный ИИ Claude
                            </p>
                            <p>
                                • Для использования ChatGPT API добавьте ключ в настройках
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<VoiceAIAssistant />, document.getElementById('root'));
    </script>
    
    <script>
        // Service Worker для PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
